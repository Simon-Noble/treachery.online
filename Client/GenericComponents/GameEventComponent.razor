<!--
 * Copyright 2020-2022 Ronald Ossendrijver. All rights reserved.
--->

@using Treachery.Shared;
@inherits GameComponent
@typeparam GameEventType
 
@code {

    protected virtual Faction IsFactionSpecific { get; set; } = Faction.None;

    protected virtual bool IsUrgent { get; set; } = false;

    [Parameter]
    public string BackgroundImage
    {
        get
        {
            return Background;
        }
        set
        {
            Background = value;
        }
    }

    protected virtual string Background { get; set; } = "";

    protected string validationError = "";

    protected async Task Confirm()
    {
        await Request(ConfirmedResult);
        StateHasChanged();
    }

    protected async Task Pass()
    {
        await Request(PassedResult);
        StateHasChanged();
    }

    protected async Task Other()
    {
        await Request(OtherResult);
        StateHasChanged();
    }

    protected Message Validation
    {
        get
        {
            try
            {
                return ConfirmedResult.Validate();
            }
            catch (Exception)
            {
                return Message.Express("Validation failed");
            }
        }
    }

    protected List<string> ValidValues<T>(IEnumerable<T> values)
    {
        return values.Select(o => Name(o)).ToList();
    }

    protected void SetIfValid<DisplayType, OriginalType>(ref DisplayType field, IEnumerable<OriginalType> validValues, OriginalType newValue)
    {
        if ((object)field != (object)newValue && validValues.Contains(newValue))
        {
            bool sameType = (typeof(OriginalType) == typeof(DisplayType));
            bool useId = (typeof(DisplayType) == typeof(int)) && typeof(IIdentifiable).IsAssignableFrom(typeof(OriginalType));

            if (sameType)
            {
                field = (DisplayType)(object)newValue;
            }
            else if (useId)
            {
                field = (DisplayType)((object)((IIdentifiable)newValue).Id);
            }
            else
            {
                field = (DisplayType)(object)Name(newValue);
            }

            StateHasChanged();
        }
    }

    protected string BackgroundStyle
    {
        get
        {
            if (Background == "")
            {
                if (IsFactionSpecific == Faction.None)
                {
                    return "";
                }
                else
                {
                    return string.Format("background-color: {0};", Skin.Current.GetFactionColorTransparant(IsFactionSpecific, "48"));
                }
            }
            else
            {
                return string.Format("background-color: rgba(0,0,0,0); background-image: url('{0}'); background-origin: content-box; background-size: cover; background-repeat: no-repeat;", BackgroundImage);
            }
        }
    }

    protected string HeaderStyle => Background != "" ? "background-color:rgba(0,0,0,0.9);" : "";

    protected string BodyStyle => Background != "" ? "background-color:rgba(0,0,0,0.7);" : "";
}
