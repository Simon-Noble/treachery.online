<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="Description" content="Online multiplayer game inspired by the Dune board game" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />

    <title>treachery.online</title>

    <base href="/" />

    <link href="https://bootswatch.com/5/darkly/bootstrap.min.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>

    <link rel="stylesheet" href="css/app.css" />

    <script type="text/javascript">

        const LoggingEnabled = false;

        function GetLocalStorageKeys() {

            let result = [];
            for (let i = 0; i < localStorage.length; i++)
            {
                result.push(localStorage.key(i));
            }

            return result;
        }

        function MeasureText(text, font) {

            // re-use canvas object for better performance
            const canvas = MeasureText.canvas || (MeasureText.canvas = document.createElement("canvas"));
            const context = canvas.getContext("2d");

            context.font = font;
            const metrics = context.measureText(text);

            if ("fontBoundingBoxAscent" in metrics) {

                return {
                    Width: metrics.width,
                    Height: metrics.fontBoundingBoxAscent + metrics.fontBoundingBoxDescent,
                };
            }
            else {

                return {
                    Width: metrics.width,
                    Height: 1.4 * (metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent),
                };
            }
        }

        function SetPlanetMapScale() {

            try {

                planetmap = document.getElementById('planetmap');
                if (planetmap != null) {

                    mapdiv = document.getElementById('mapdiv');
                    if (mapdiv != null) {

                        planetmap_inner = document.getElementById('planetmap_inner');
                        scale = mapdiv.offsetWidth / planetmap_inner.offsetWidth;
                        planetmap.style.transform = 'scale(' + scale + ')';

                        planetmap_filler = document.getElementById('planetmap-filler');
                        planetmap_filler.style.height = 1.110012062726176 * mapdiv.offsetWidth + "px";
                    }
                }
            }
            catch {

            }
        }

        function GetWindowDimensions() {

            try {

                determinedWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
                determinedHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
            }
            catch (error) {

                determinedWidth = 800;
                determinedHeight = 600;
            }

            return { Width: determinedWidth, Height: determinedHeight };
        }

        function GetScreenDimensions() {

            return { Width: window.screen.width * window.devicePixelRatio, Height: window.screen.height * window.devicePixelRatio };
        }

        function GetImageDimensions(imgUrl) {

            return new Promise((resolve) => {
                let img = document.createElement('img');
                img.onload = () => {
                    resolve({ Width: img.naturalWidth, Height: img.naturalHeight });
                }
                img.onerror = () => {
                    resolve({ Width: 0, Height: 0 });
                }
                img.src = imgUrl;
            });
        }

        function RemoveFocusFromButtons() {

            document.querySelectorAll("button").forEach(item => item.blur());
        }

        function EnablePopover(element) {

            new bootstrap.Popover(element, { sanitize: false });
        }
                
        function EnablePopovers(element) {

            element.querySelectorAll('[data-bs-toggle="popover"]').forEach( function (trigger) { EnablePopover(trigger); } );
        }

        function RemovePopover(element) {

            var popover = bootstrap.Popover.getInstance(element);

            if (popover != null) {

                popover.dispose();
            }
        }

        function RemovePopovers(element) {
            
            element.querySelectorAll('[data-bs-toggle="popover"]').forEach( function (trigger) { RemovePopover(trigger); } );
        }

        function RefreshPopover(element) {

            var popover = bootstrap.Popover.getInstance(element);
            if (popover != null) {

                popover.dispose();
            }

            new bootstrap.Popover(element, { sanitize: false });
        }

        function RefreshPopovers(element) {
            
            element.querySelectorAll('[data-bs-toggle="popover"]').forEach( function (trigger) { RefreshPopover(trigger); } );
        }

        /*
         * Sounds
         */

        Howler.autoUnlock = false;

        let sounds = new Map();
        function PlaySound(file, volume, loop) {

            Log("PlaySound(" + file + "," + volume + "," + loop + ")");

            try {

                let sound = sounds.get(file);
                if (sound == null) {

                    sound = new Howl({ src: file, html5: true, volume: volume, loop: loop });
                    sounds.set(file, sound);
                }
                else {

                    sound.stop();
                    sound.volume(volume);
                    sound.loop(loop);
                }

                sound.play();
            }
            catch (error) {

                //
            }
        }

        function StopSound(file) {

            let sound = sounds.get(file);
            if (sound != null) {

                Log("StopSound(" + file + ")");

                sound.stop();
            }
        }

        function FadeSound(file, fromVolume, toVolume, seconds) {

            let sound = sounds.get(file);
            if (sound != null) {

                Log("FadeSound(" + file + "," + fromVolume + "," + toVolume + "," + seconds + ")");

                sound.fade(fromVolume, toVolume, seconds);
            }
        }

        function ChangeSoundVolume(file, volume) {

            let sound = sounds.get(file);
            if (sound != null) {

                Log("ChangeSoundVolume(" + file + "," + volume + ")");
                sound.volume(volume);
            }
        }

        function StopSounds() {

            Log("StopSounds()");
            Howler.stop();
        }

        /*
         * Read and write files locally
         */

        function saveFile(filename, data) {

            let link = document.createElement('a');
            link.download = filename;
            link.href = "data:text/plain," + data;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function readFile(inputFile) {

            const temporaryFileReader = new FileReader();
            return new Promise((resolve, reject) => {

                temporaryFileReader.onerror = () => {
                    temporaryFileReader.abort();
                    reject(new DOMException("Problem parsing input file."));
                };

                temporaryFileReader.addEventListener("load", function () {
                    resolve(temporaryFileReader.result);
                }, false);

                temporaryFileReader.readAsText(inputFile.files[0]);
            });
        }

        function Clear(id) {

            document.getElementById(id).value = "";
        }

        function UrlExists(url) {

            let img = new Image();

            return new Promise(

                (resolve) => {

                    img.onerror = () => {
                        resolve(false);
                    };

                    img.onload = () => {
                        resolve(true);
                    };

                    img.src = url;

                });
        }

        /*
         * Other support functions
         */

        function ClearSelection() {

            if (window.getSelection) { window.getSelection().removeAllRanges(); }
            else if (document.selection) { document.selection.empty(); }
        }

        function HideModal(modalId) {

            let element = document.getElementById(modalId);
            let modal = bootstrap.Modal.getInstance(element);

            if (modal != null) {

                modal.hide();
            }
        }

        function ToggleFullScreen() {

            let element = document.body;
            let isFullscreen = IsFullScreen();

            element.requestFullScreen = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || function () { return false; };
            document.cancelFullScreen = document.cancelFullScreen || document.webkitCancelFullScreen || document.mozCancelFullScreen || function () { return false; };

            isFullscreen ? document.cancelFullScreen() : element.requestFullScreen();
        }

        function IsFullScreen() {

            return document.fullscreenElement != null
        }

        function Print(elementId) {

            let elem = document.getElementById(elementId);
            let domClone = elem.cloneNode(true);
            let printSection = document.getElementById("printSection");

            if (!printSection) {

                printSection = document.createElement("div");
                printSection.id = "printSection";
                document.body.appendChild(printSection);
            }

            printSection.innerHTML = "";
            printSection.appendChild(domClone);
            window.print();
        }

        function Log(text) {

            if (LoggingEnabled) {

                console.log(text);
            }
        }

    </script>

</head>

<body style="background-color:black">

    <div id="app">Loading...</div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>

    <script src="_framework/blazor.webassembly.js"></script>

    <script type="text/javascript">

        window.onbeforeunload = function () { return "This will disconnect you from the game! Are you sure?"; }
        window.addEventListener("resize", SetPlanetMapScale);

    </script>

</body>

</html>
