<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="Description" content="Online multiplayer game inspired by the Dune board game" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />

    <title>treachery.online</title>

    <base href="/" />

    <link href="https://bootswatch.com/5/darkly/bootstrap.min.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/jspanel4@4.13.0/dist/jspanel.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspanel4@4.13.0/dist/jspanel.min.css">

    <link rel="stylesheet" href="css/app.css" />

    <script type="text/javascript">

        function GetLocalStorageKeys() {

            let result = [];
            for (let i = 0; i < localStorage.length; i++) {
                result.push(localStorage.key(i));
            }

            return result;
        }

        function MeasureText(text, font) {

            // re-use canvas object for better performance
            const canvas = MeasureText.canvas || (MeasureText.canvas = document.createElement("canvas"));
            const context = canvas.getContext("2d");

            context.font = font;
            const metrics = context.measureText(text);

            if ("fontBoundingBoxAscent" in metrics) {

                return {
                    Width: metrics.width,
                    Height: metrics.fontBoundingBoxAscent + metrics.fontBoundingBoxDescent,
                };
            }
            else {

                return {
                    Width: metrics.width,
                    Height: 1.4 * (metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent),
                };
            }
        }

        function SetPlanetMapScale() {

            planetmap = document.getElementById('planetmap');
            if (planetmap != null) {

                mapdiv = document.getElementById('mapdiv');
                if (mapdiv != null) {

                    planetmap_inner = document.getElementById('planetmap_inner');
                    scale = mapdiv.offsetWidth / planetmap_inner.offsetWidth;
                    planetmap.style.transform = 'scale(' + scale + ')';

                    planetmap_filler = document.getElementById('planetmap-filler');
                    planetmap_filler.style.height = 1.110012062726176 * mapdiv.offsetWidth + "px";
                }
            }

        }

        function GetWindowDimensions() {

            return {
                Width: window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth,
                Height: window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight
            };
        }

        function RemoveFocusFromButtons() {

            document.querySelectorAll("button").forEach(item => item.blur());
        }

        function RefreshPopovers() {
            
            $('[data-bs-toggle="popover"]').popover('dispose');
            EnablePopovers();
        }

        function EnablePopovers() {
            
            //document.querySelectorAll("[data-bs-toggle='popover']").forEach(item => new bootstrap.Popover(item, { sanitize: false }));
            $('[data-bs-toggle="popover"]').popover({ sanitize: false });
        }

        function SendChatMessage() {

            let msgElt = document.getElementById("messageSentBody");
            let body = msgElt.value;
            msgElt.value = '';
            let target = document.getElementById("messageSentTarget").value;
            DotNet.invokeMethodAsync('Treachery.Client', 'SendMessage', body, target)
        }

        function AddChatEnterListener() {

            let chatMessageBody = document.getElementById('messageSentBody');
            if (chatMessageBody != null) {
                chatMessageBody.addEventListener('keyup', function (event) {
                    if (event.key == "Enter") {
                        SendChatMessage();
                    }
                });
            }
        }

        function AddEnterListeners() {

            let userName = document.getElementById('userName');
            if (userName != null) {
                userName.addEventListener('keyup', function (event) {
                    if (event.key == "Enter") {
                        DotNet.invokeMethodAsync('Treachery.Client', 'ConfirmUsername');
                    }
                });
            }
        }

        /*
         * Sounds
         */

        Howler.autoUnlock = false;

        let sounds = new Map();
        function PlaySound(file, volume, loop) {

            let sound = sounds.get(file);
            if (sound == null) {

                sound = new Howl({ src: file, html5: true, volume: volume, loop: loop });
                sounds.set(file, sound);
            }
            else {

                sound.stop();
                sound.volume(volume);
                sound.loop(loop);
            }

            sound.play();
        }

        function StopSound(file) {

            let sound = sounds.get(file);
            if (sound != null) {

                sound.stop();
            }
        }

        function FadeSound(file, fromVolume, toVolume, seconds) {

            let sound = sounds.get(file);
            if (sound != null) {

                sound.fade(fromVolume, toVolume, seconds);
            }
        }

        function ChangeSoundVolume(file, volume) {

            let sound = sounds.get(file);
            if (sound != null) {

                sound.volume(volume);
            }
        }

        function StopSounds() {

            Howler.stop();
        }

        /*
         * Read and write files locally
         */

        function saveFile(filename, data) {

            let link = document.createElement('a');
            link.download = filename;
            link.href = "data:text/plain," + data;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function readFile(inputFile) {

            const temporaryFileReader = new FileReader();
            return new Promise((resolve, reject) => {

                temporaryFileReader.onerror = () => {
                    temporaryFileReader.abort();
                    reject(new DOMException("Problem parsing input file."));
                };

                temporaryFileReader.addEventListener("load", function () {
                    resolve(temporaryFileReader.result);
                }, false);

                temporaryFileReader.readAsText(inputFile.files[0]);
            });
        }

        function Clear(id) {

            document.getElementById(id).value = "";
        }

        function UrlExists(url) {

            let img = new Image();

            return new Promise(

                (resolve) => {

                    img.onerror = () => {
                        resolve(false);
                    };

                    img.onload = () => {
                        resolve(true);
                    };

                    img.src = url;

                });
        }

        /*
         * Floating Panel (JSPanel) support functions
         */

        let panels = new Map();
        function CreateJsPanel(options) {

            let newPanel = jsPanel.create(options);
            panels.set(newPanel.id, newPanel);
            return newPanel.id;
        }

        function UpdateJsPanel(panelID, elementRef, options) {

            if (panelID != null) {

                try {

                    let existingPanel = panels.get(panelID);
                    existingPanel.content = elementRef;
                    return panelID;
                }
                catch (error) {

                    //
                }
            }
        }

        function HideJsPanel(panelID) {

            if (panelID != null) {

                try {

                    let existingPanel = panels.get(panelID);
                    existingPanel.opacity = 0.2;
                }
                catch (error) {

                    //
                }
            }
        }

        function CloseJsPanel(panelID) {

            if (panelID != null) {

                try {

                    let existingPanel = panels.get(panelID);
                    existingPanel.close();
                    panels.delete(panelID);
                }
                catch (error) {

                    //
                }
            }
        }

        /*
         * Popout Chat Panel functions
         */

        var chatPopup;
        function OpenChatPopup() {

            if (chatPopup == null) {

                let eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
                let eventer = window[eventMethod];
                let messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

                // Listen to message from child window
                eventer(messageEvent, function (e) {

                    DotNet.invokeMethodAsync('Treachery.Client', 'SendMessage', e.data.body, e.data.target)

                }, false);
            }

            chatPopup = window.open("chat.html", "mywindow", "width=640,height=480,status=no,titlebar=no,location=no");
            chatPopup.onload = ChatPopupLoaded();
        }

        function ChatPopupLoaded() {

            if (chatPopup != null) {

                DotNet.invokeMethodAsync('Treachery.Client', 'InitializeChatPopup')
                chatPopup.focus();
            }
        }

        function SendToChatPopup(chatobj) {

            if (chatPopup != null) {
                chatPopup.postMessage(chatobj, '*');
            }
        }

        /*
         * Other support functions
         */

        function ClearSelection() {

            if (window.getSelection) { window.getSelection().removeAllRanges(); }
            else if (document.selection) { document.selection.empty(); }
        }

        function HideModal(modalId) {

            document.getElementById(modalId).modal('hide');
        }

        function ToggleFullScreen() {

            let element = document.body;
            let isFullscreen = IsFullScreen();

            element.requestFullScreen = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || function () { return false; };
            document.cancelFullScreen = document.cancelFullScreen || document.webkitCancelFullScreen || document.mozCancelFullScreen || function () { return false; };

            isFullscreen ? document.cancelFullScreen() : element.requestFullScreen();
        }

        function IsFullScreen() {

            return document.fullscreenElement != null
        }

        function Print(elementId) {

            let elem = document.getElementById(elementId);
            let domClone = elem.cloneNode(true);
            let printSection = document.getElementById("printSection");

            if (!printSection) {

                printSection = document.createElement("div");
                printSection.id = "printSection";
                document.body.appendChild(printSection);
            }

            printSection.innerHTML = "";
            printSection.appendChild(domClone);
            window.print();
        }

        function Reload() {

            window.onbeforeunload = null;
            location.reload();
        }

        /*
         * Webcam
         */

        const webcamCodec = 'video/webm;codecs="vp8,opus"';
        const webcamInterval = 1000;

        async function GetCaptureDevices(getPermissionsFirst) {

            if (getPermissionsFirst) {

                await navigator.mediaDevices.getUserMedia({ audio: true, video: true })
                    .then(function (stream) {

                        devices = GetDevices(stream);
                    });
            }
            else {

                devices = GetDevices();
            }

            return devices;
        }

        async function GetDevices(stream) {

            let result = await navigator.mediaDevices.enumerateDevices();

            if (stream != null) {
                stream.getTracks().forEach(function (track) {
                    track.stop();
                });
            }

            return result;
        }

        var mediaRecorder = null;
        var recordedStream = null;
        function CaptureMedia(videoId, audioDeviceId, videoDeviceId) {

            navigator.mediaDevices.getUserMedia(
                {
                    audio: {
                        echoCancellation: true,
                        autoGainControl: true,
                        noiseSuppression: true,
                        deviceId: { exact: audioDeviceId }
                    },
                    video: {
                        width: { ideal: 320 },
                        height: { ideal: 200 },
                        deviceId: { exact: videoDeviceId }
                    }
                })
                .then(function (stream) {

                    recordedStream = stream;

                    video = document.getElementById(videoId);
                    if (video != null) {

                        video.srcObject = stream;
                        video.muted = true;
                        video.play();
                    }

                    mediaRecorder = new MediaRecorder(stream, { mimeType: webcamCodec });
                    mediaRecorder.ondataavailable = HandleVideoData
                    mediaRecorder.start(webcamInterval);
                });
        }

        async function HandleVideoData(event) {

            let arraybuffer = await event.data.arrayBuffer()
            let bytes = new Uint8Array(arraybuffer);
            DotNet.invokeMethodAsync('Treachery.Client', 'HandleVideoData', bytes);
        }

        function StopCapture(videoId) {

            if (mediaRecorder != null) {

                mediaRecorder.stop();

                recordedStream.getTracks().forEach(function (track) {
                    track.stop();
                });
            }

            StopVideo(videoId);
        }

        function StopVideo(videoId) {

            let video = document.getElementById(videoId);
            if (video != null) {

                video.pause();
                video.src = '';
                video.load();
            }
        }

        var mediaSources = new Map();
        function InitializeVideo(videoId) {

            try {

                let mediaSource = new MediaSource();
                mediaSource.addEventListener('sourceopen', sourceOpen);
                mediaSources.set(videoId, mediaSource);

                let video = document.getElementById(videoId);
                video.src = URL.createObjectURL(mediaSource);
                video.play();
            }
            catch (error) {

                //
            }
        }

        function sourceOpen(_) {

            if (this.readyState == "open") {

                let buffer = this.addSourceBuffer(webcamCodec);
                buffer.mode = "sequence";
            }
        };

        async function PushVideoData(videoId, buffer, volume) {

            try {
                let mediaSource = mediaSources.get(videoId)
                let video = document.getElementById(videoId);

                if (video != null) {

                    if (mediaSource != null) {

                        if (mediaSource.sourceBuffers.length > 0) {

                            video.volume = volume;

                            let sourceBuffer = mediaSource.sourceBuffers[0];

                            if (sourceBuffer.buffered.length > 0) {

                                if (video.buffered.end(0) - video.currentTime > 1) {

                                    video.playbackRate = 1.5;
                                }
                                else {

                                    video.playbackRate = 1;
                                }
                            }

                            sourceBuffer.appendBuffer(buffer.buffer);

                            while (sourceBuffer.updating) {

                                await Sleep(100);
                            }

                            if (video.ended) {

                                video.play();
                            }
                        }
                        else {

                            mediaSources.delete(videoId);
                            InitializeVideo(videoId);
                        }
                    }
                    else {

                        InitializeVideo(videoId);
                    }
                }
            }
            catch (error) {

                //
            }
        }

        function Sleep(ms) {

            return new Promise(resolve => setTimeout(resolve, ms));
        }

    </script>

</head>

<body style="background-color:black">

    <div id="app">Loading...</div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>

    <script src="_framework/blazor.webassembly.js"></script>

    <script type="text/javascript">

        window.onbeforeunload = function () { return "This will disconnect you from the game! Are you sure?"; }
        window.addEventListener("resize", SetPlanetMapScale);

    </script>

</body>

</html>
