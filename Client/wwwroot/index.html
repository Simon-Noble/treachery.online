<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="Description" content="Online multiplayer game inspired by the Dune board game" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />

    <title>treachery.online</title>

    <base href="/" />

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/jspanel4@4.12.0/dist/jspanel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.6.0/dist/darkly/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspanel4@4.12.0/dist/jspanel.min.css">
    
    <link rel="stylesheet" href="css/app.css" />

    <script type="text/javascript">

        function GetLocalStorageKeys() {

            let result = [];
            for (let i = 0; i < localStorage.length; i++) {
                result.push(localStorage.key(i));
            }

            return result;
        }

        function MeasureText(text, font) {

            // re-use canvas object for better performance
            const canvas = MeasureText.canvas || (MeasureText.canvas = document.createElement("canvas"));
            const context = canvas.getContext("2d");
            
            context.font = font;
            const metrics = context.measureText(text);

            return {
                Width: metrics.width,
                Height: metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent,
            };
        }
        
        function SetPlanetMapScale() {
            
            planetmap = document.getElementById('planetmap');
            if (planetmap != null) {

                planetmap_inner = document.getElementById('planetmap_inner');
                planetmap_filler = document.getElementById('planetmap-filler');
                mapdiv = document.getElementById('mapdiv');

                if (mapdiv != null) {
                    scale = mapdiv.offsetWidth / planetmap_inner.offsetWidth;
                    planetmap.style.transform = 'scale(' + scale + ')';
                    planetmap_filler.style.width = mapdiv.offsetWidth + "px";
                    planetmap_filler.style.height = 1.110012062726176 * mapdiv.offsetWidth + "px";
                }
            }
            
        }
        
        function GetWindowDimensions() {

            return { Width: $(window).width(), Height: $(window).height() };
        }

        function RemoveFocusFromButtons() {

            $(':button').blur();
        }

        function RefreshPopovers() {

            $('.popover').popover('dispose');
            EnablePopovers();
        }

        function EnablePopovers() {

            $('[data-toggle="popover"]').popover({ sanitize: false });
        }
        
        function SendChatMessage() {

            var msgElt = document.getElementById("messageSentBody");
            var body = msgElt.value;
            msgElt.value = '';
            var target = document.getElementById("messageSentTarget").value;
            DotNet.invokeMethodAsync('Treachery.Client', 'SendMessage', body, target)
        }

        function AddChatEnterListener() {

            var chatMessageBody = document.getElementById('messageSentBody');
            if (chatMessageBody != null) {
                chatMessageBody.addEventListener('keyup', function (event) {
                    if (event.key == "Enter") {
                        SendChatMessage();
                    }
                });
            }
        }

        function AddEnterListeners() {

            var userName = document.getElementById('userName');
            if (userName != null) {
                userName.addEventListener('keyup', function (event) {
                    if (event.key == "Enter") {
                        DotNet.invokeMethodAsync('Treachery.Client', 'ConfirmUsername');
                    }
                });
            }
        }

        /*
         * Sounds
         */

        Howler.autoUnlock = false;

        let sounds = new Map();
        function PlaySound(file, volume, loop) {

            var sound = sounds.get(file);
            if (sound == null) {

                sound = new Howl({ src: file, html5: true, volume: volume, loop: loop });
                sounds.set(file, sound);
            }
            else {

                sound.stop();
                sound.volume(volume);
                sound.loop(loop);
            }

            sound.play();
        }

        function StopSound(file) {

            var sound = sounds.get(file);
            if (sound != null) {

                sound.stop();
            }
        }

        function FadeSound(file, fromVolume, toVolume, seconds) {

            var sound = sounds.get(file);
            if (sound != null) {

                sound.fade(fromVolume, toVolume, seconds);
            }
        }

        function ChangeSoundVolume(file, volume) {

            var sound = sounds.get(file);

            if (sound != null) {

                sound.volume(volume);
            }
        }

        function StopSounds() {

            Howler.stop();
        }

        /*
         * Read and write files locally
         */

        function saveFile(filename, data) {

            var link = document.createElement('a');
            link.download = filename;
            link.href = "data:text/plain," + data;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function readFile(inputFile) {

            const temporaryFileReader = new FileReader();
            return new Promise((resolve, reject) => {

                temporaryFileReader.onerror = () => {
                    temporaryFileReader.abort();
                    reject(new DOMException("Problem parsing input file."));
                };

                temporaryFileReader.addEventListener("load", function () {
                    resolve(temporaryFileReader.result);
                }, false);

                temporaryFileReader.readAsText(inputFile.files[0]);
            });
        }

        function Clear(id) {

            document.getElementById(id).value = "";
        }

        function UrlExists(url) {

            let img = new Image();

            return new Promise(

                (resolve) => {

                    img.onerror = () => {
                        resolve(false);
                    };

                    img.onload = () => {
                        resolve(true);
                    };

                    img.src = url;

                });
        }

        /*
         * Floating Panel (JSPanel) support functions
         */

        let panels = new Map();
        function CreateJsPanel(options) {

            var newPanel = jsPanel.create(options);
            panels.set(newPanel.id, newPanel);
            return newPanel.id;
        }

        function UpdateJsPanel(panelID, elementRef, options) {

            if (panelID != null) {
                var existingPanel = panels.get(panelID);
                existingPanel.content = elementRef;
                return panelID;
            }
        }

        function HideJsPanel(panelID) {

            if (panelID != null) {
                var existingPanel = panels.get(panelID);
                existingPanel.opacity = 0.2;
            }
        }

        function CloseJsPanel(panelID) {

            if (panelID != null) {
                var existingPanel = panels.get(panelID);
                existingPanel.close();
                panels.delete(panelID);
            }
        }

        /*
         * Popout Chat Panel functions
         */

        var chatPopup;
        function OpenChatPopup() {

            if (chatPopup == null) {

                var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
                var eventer = window[eventMethod];
                var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

                // Listen to message from child window
                eventer(messageEvent, function (e) {

                    DotNet.invokeMethodAsync('Treachery.Client', 'SendMessage', e.data.body, e.data.target)

                }, false);
            }

            chatPopup = window.open("chat.html", "mywindow", "width=640,height=480,status=no,titlebar=no,location=no");
            chatPopup.onload = ChatPopupLoaded();
        }

        function ChatPopupLoaded() {

            if (chatPopup != null) {

                DotNet.invokeMethodAsync('Treachery.Client', 'InitializeChatPopup')
                chatPopup.focus();
            }
        }

        function SendToChatPopup(chatobj) {

            if (chatPopup != null) {
                chatPopup.postMessage(chatobj, '*');
            }
        }

        /*
         * Other support functions
         */

        function ClearSelection() {

            if (window.getSelection) { window.getSelection().removeAllRanges(); }
            else if (document.selection) { document.selection.empty(); }
        }

        function HideModal(modalId) {

            $(modalId).modal('hide');
        }

        function ToggleFullScreen() {

            var element = document.body;

            var isFullscreen = document.webkitIsFullScreen || document.mozFullScreen || false;

            element.requestFullScreen = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || function () { return false; };
            document.cancelFullScreen = document.cancelFullScreen || document.webkitCancelFullScreen || document.mozCancelFullScreen || function () { return false; };

            isFullscreen ? document.cancelFullScreen() : element.requestFullScreen();
        }

        function Print(elementId) {

            var elem = document.getElementById(elementId);

            var domClone = elem.cloneNode(true);

            var $printSection = document.getElementById("printSection");

            if (!$printSection) {
                var $printSection = document.createElement("div");
                $printSection.id = "printSection";
                document.body.appendChild($printSection);
            }

            $printSection.innerHTML = "";
            $printSection.appendChild(domClone);
            window.print();
        }

        function Reload() {

            window.onbeforeunload = null;
            location.reload();
        }
        
    </script>

</head>

<body>

    <div id="app">Loading...</div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>

    <script src="_framework/blazor.webassembly.js"></script>

    <script type="text/javascript">

        window.onbeforeunload = function () { return "This will disconnect you from the game! Are you sure?"; }
        window.addEventListener("resize", SetPlanetMapScale);

    </script>

</body>

</html>
