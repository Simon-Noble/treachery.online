<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>treachery.online chat</title>

    <base href="/" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.4.1/darkly/bootstrap.min.css">
    <link href="css/app.css" rel="stylesheet" />

    <script type="text/javascript">

        function AddChatEnterListener() {

            var chatMessageBody = document.getElementById('message');
            if (chatMessageBody != null) {
                chatMessageBody.addEventListener('keyup', function (event) {
                    if (event.key == "Enter") {
                        SendChatMessage();
                    }
                });
            }
        }

        function Clear(id) {

            document.getElementById(id).value = "";
        }

        // Create IE + others compatible event handler
        let messages = new Array();
        var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
        var eventer = window[eventMethod];
        var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

        var parentWindow;

        // Listen to message from parent window
        eventer(messageEvent, function (e) {
            
            if (e.data.type == 'PopupChatInitialize') {

                parentWindow = e.source;

                for (var i = 0; i < e.data.playerNames.length; i++) {

                    document.getElementById("targets").innerHTML += "<option style='color:" + e.data.playerStyles[i] + ";background-color:white'>" + e.data.playerNames[i] + "</option>";
                }

                for (var i = e.data.messages.length - 1; i >= 0; i--) {

                    AddMessage(e.data.messages[i].style, e.data.messages[i].body);
                }
            }
            else if (e.data.type == 'PopupChatMessage') {

                AddMessage(e.data.style, e.data.body);
            }
            else if (e.data.type == 'PopupChatClear') {

                ClearChatMessages();
            }

        }, false);

        function SendChatMessage() {

            var chatObj = { target: document.getElementById("targets").value, body: document.getElementById("message").value }
            if (parentWindow != null) {
                parentWindow.postMessage(chatObj, '*');
            }
            Clear("message");
        }

        function AddMessage(style, body) {

            document.getElementById("messages").innerHTML = "<div class='text-break p-1 mt-1' style='background-color:" + style + "'>" + body + "</div>" + document.getElementById("messages").innerHTML;
        }

        function ClearChatMessages() {

            document.getElementById("messages").innerHTML = "";
        }

    </script>

</head>

<body>

    <div class="p-1">

        <input class='form-control form-control-sm' type='text' maxlength='512' placeholder='Your message...' id='message'>

        <div class='form-inline'>
            <select class='form-control-sm mt-1' id='targets'>
                <option style='color:red;background-color:white'>EVERYONE</option>
            </select>
            <button class='btn btn-primary form-control-sm btn-sm mt-1 ml-1' onclick='SendChatMessage()'>Send</button>
        </div>

        <div class="text-break mt-1 small" id="messages" />

    </div>

    <script>
        AddChatEnterListener();
    </script>

</body>



</html>
