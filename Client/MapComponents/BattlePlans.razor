<!--
 * Copyright 2020-2023 Ronald Ossendrijver. All rights reserved.
--->

@using Treachery.Shared
@inherits MapComponent

@if (Game.CurrentMainPhase == MainPhase.Battle && Game.CurrentPhase != Phase.BattleReport)
{
    bool MaySeeAggressorBattlePlan = Game.AggressorPlan != null && (Game.AggressorPlan.Initiator == h.Faction || Game.GreenKarma && Game.CurrentBattle.OpponentOf(Faction.Green) == Game.AggressorPlan.Player);
    bool MaySeeDefenderBattlePlan = Game.DefenderPlan != null && (Game.DefenderPlan.Initiator == h.Faction || Game.GreenKarma && Game.CurrentBattle.OpponentOf(Faction.Green) == Game.DefenderPlan.Player);

    bool MaySeeBothBattlePlans = Game.AggressorPlan != null && Game.DefenderPlan != null;
    
    bool AggressorIsAffectedByPartialPrescience = Game.AggressorPlan != null && 
        (Game.CurrentPrescience != null && Game.CurrentBattle.OpponentOf(Game.CurrentPrescience.Initiator) == Game.AggressorPlan.Player ||
         Game.CurrentNexusPrescience != null && Game.CurrentBattle.OpponentOf(Game.CurrentNexusPrescience.Initiator) == Game.AggressorPlan.Player);

    bool DefenderIsAffectedByPartialPrescience = Game.DefenderPlan != null && 
        (Game.CurrentPrescience != null && Game.CurrentBattle.OpponentOf(Game.CurrentPrescience.Initiator) == Game.DefenderPlan.Player ||
         Game.CurrentNexusPrescience != null && Game.CurrentBattle.OpponentOf(Game.CurrentNexusPrescience.Initiator) == Game.DefenderPlan.Player);

    bool AggressorCallsTraitor = Game.AggressorTraitorAction != null && Game.AggressorTraitorAction.Succeeded;
    bool DefenderCallsTraitor = Game.DefenderTraitorAction != null && Game.DefenderTraitorAction.Succeeded;

    bool AggressorWasFacedanced = Game.Version > 150 && Game.CurrentPhase == Phase.Facedancing && Game.CurrentBattle.Aggressor == Game.BattleWinner;
    bool DefenderWasFacedanced = Game.Version > 150 && Game.CurrentPhase == Phase.Facedancing && Game.CurrentBattle.Defender == Game.BattleWinner;

    var x = 0.1f * Skin.Current.MapDimensions.X;
    var y = 0.1f * Skin.Current.MapDimensions.Y;

    if (MaySeeAggressorBattlePlan || MaySeeBothBattlePlans)
    {
        <BattlePlan h="h" Plan="Game.AggressorPlan" ShowEntirePlan=true OpponentPlan="Game.DefenderPlan" Facedanced="AggressorWasFacedanced" TraitorCalled="DefenderCallsTraitor" IsAggressor="true" X="x" Y="y" />
    }
    else if (MaySeeAggressorBattlePlanUnderConstruction)
    {
        <BattlePlan h="h" Plan="h.BattleUnderConstruction" ShowEntirePlan=true OpponentPlan="Game.DefenderPlan" Facedanced="AggressorWasFacedanced" TraitorCalled="false" IsAggressor="true" X="x" Y="y" />
    }
    else if (AggressorIsAffectedByPartialPrescience)
    {
        <BattlePlan h="h" Plan="Game.AggressorPlan" ShowEntirePlan=false OpponentPlan="Game.DefenderPlan" Facedanced="AggressorWasFacedanced" TraitorCalled="false" IsAggressor="true" X="x" Y="y" Opacity="0.5f" />
    }

    x = 0.4f * Skin.Current.MapDimensions.X;
    y = 0.5f * Skin.Current.MapDimensions.Y;

    if (MaySeeDefenderBattlePlan || MaySeeBothBattlePlans)
    {
        <BattlePlan h="h" Plan="Game.DefenderPlan" ShowEntirePlan=true OpponentPlan="Game.AggressorPlan" Facedanced="DefenderWasFacedanced" TraitorCalled="AggressorCallsTraitor" IsAggressor="false" X="x" Y="y" />
    }
    else if (MaySeeDefenderBattlePlanUnderConstruction)
    {
        <BattlePlan h="h" Plan="h.BattleUnderConstruction" ShowEntirePlan=true OpponentPlan="Game.AggressorPlan" Facedanced="DefenderWasFacedanced" TraitorCalled="false" IsAggressor="false" X="x" Y="y" />
    }
    else if (DefenderIsAffectedByPartialPrescience)
    {
        <BattlePlan h="h" Plan="Game.DefenderPlan" ShowEntirePlan=false OpponentPlan="Game.AggressorPlan" Facedanced="DefenderWasFacedanced" TraitorCalled="false" IsAggressor="false" X="x" Y="y" Opacity="0.5f" />
    }
}

@code {

    private bool MaySeeAggressorBattlePlanUnderConstruction => h.BattleUnderConstruction != null && Game.AggressorPlan == null && Game.CurrentBattle != null && Game.CurrentBattle.Aggressor == h.Faction;

    private bool MaySeeDefenderBattlePlanUnderConstruction => h.BattleUnderConstruction != null && Game.DefenderPlan == null && Game.CurrentBattle != null && Game.CurrentBattle.Defender == h.Faction;
}
