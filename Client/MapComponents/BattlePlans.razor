@using Treachery.Shared
@inherits MapComponent

@if (Game.CurrentMainPhase == MainPhase.Battle && h.ShowWheelsAndHMS && Game.CurrentPhase != Phase.Facedancing && Game.CurrentPhase != Phase.BattleReport)
{
    bool MaySeeAggressorBattlePlan = Game.AggressorBattleAction != null && (Game.AggressorBattleAction.Initiator == h.Faction || Game.GreenKarma && Game.CurrentBattle.OpponentOf(Faction.Green) == Game.AggressorBattleAction.Player);
    bool MaySeeDefenderBattlePlan = Game.DefenderBattleAction != null && (Game.DefenderBattleAction.Initiator == h.Faction || Game.GreenKarma && Game.CurrentBattle.OpponentOf(Faction.Green) == Game.DefenderBattleAction.Player);
    bool MaySeeBothBattlePlans = Game.AggressorBattleAction != null && Game.DefenderBattleAction != null;
    bool AggressorIsAffectedByPartialPrescience = Game.CurrentPrescience != null && Game.AggressorBattleAction != null && Game.CurrentBattle.OpponentOf(Faction.Green) == Game.AggressorBattleAction.Player;
    bool DefenderIsAffectedByPartialPrescience = Game.CurrentPrescience != null && Game.DefenderBattleAction != null && Game.CurrentBattle.OpponentOf(Faction.Green) == Game.DefenderBattleAction.Player;
    bool AggressorCallsTraitor = Game.AggressorTraitorAction != null && Game.AggressorTraitorAction.TraitorCalled;
    bool DefenderCallsTraitor = Game.DefenderTraitorAction != null && Game.DefenderTraitorAction.TraitorCalled;

    if (MaySeeAggressorBattlePlan || MaySeeBothBattlePlans)
    {
        <BattlePlan h="h" Plan="Game.AggressorBattleAction" Opponent="Game.CurrentBattle.DefendingPlayer" TraitorCalled="DefenderCallsTraitor" IsAggressor="true" X="500" Y="200" />
    }
    else if (MaySeeAggressorBattlePlanUnderConstruction)
    {
        <BattlePlan h="h" Plan="h._battleUnderConstruction" Opponent="Game.CurrentBattle.DefendingPlayer" TraitorCalled="false" IsAggressor="true" X="500" Y="200" />
    }
    else if (AggressorIsAffectedByPartialPrescience)
    {
        <BattlePlan h="h" Plan="Game.AggressorBattleAction" Opponent="Game.CurrentBattle.DefendingPlayer" TraitorCalled="false" IsAggressor="true" X="500" Y="200" Aspect="Game.CurrentPrescience.Aspect" Opacity="0.5f"/>
    }

    if (MaySeeDefenderBattlePlan || MaySeeBothBattlePlans)
    {
        <BattlePlan h="h" Plan="Game.DefenderBattleAction" Opponent="Game.CurrentBattle.Player" TraitorCalled="AggressorCallsTraitor" IsAggressor="false" X="Skin.Current.MapDimensions.X / 2 - 500" Y="Skin.Current.MapDimensions.Y / 2" />
    }
    else if (MaySeeDefenderBattlePlanUnderConstruction)
    {
        <BattlePlan h="h" Plan="h._battleUnderConstruction" Opponent="Game.CurrentBattle.Player" TraitorCalled="false" IsAggressor="false" X="Skin.Current.MapDimensions.X / 2 - 500" Y="Skin.Current.MapDimensions.Y / 2" />
    }
    else if (DefenderIsAffectedByPartialPrescience)
    {
        <BattlePlan h="h" Plan="Game.DefenderBattleAction" Opponent="Game.CurrentBattle.Player" TraitorCalled="false" IsAggressor="false" X="Skin.Current.MapDimensions.X / 2 - 500" Y="Skin.Current.MapDimensions.Y / 2" Aspect="Game.CurrentPrescience.Aspect" Opacity="0.5f"/>
    }
}

@code {

    private bool MaySeeAggressorBattlePlanUnderConstruction => h._battleUnderConstruction != null && Game.AggressorBattleAction == null && Game.CurrentBattle != null && Game.CurrentBattle.Aggressor == h.Faction;

    private bool MaySeeDefenderBattlePlanUnderConstruction => h._battleUnderConstruction != null && Game.DefenderBattleAction == null && Game.CurrentBattle != null && Game.CurrentBattle.Defender == h.Faction;
}
